
@{
    ViewBag.Title = "ListNews";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}


<div class="row">
    <div class="col-12">
        <div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis">
            <div id="projectSummary" data-list='{"valueNames":["project","assignees","start","deadline","calculation","projectprogress","status","action"],"page":6,"pagination":true}'>
                <div class="row align-items-end justify-content-between pb-4 g-3">
                    <div class="col-auto">
                        <h3>Danh sách bài viết</h3>
                        <p class="text-body-tertiary lh-sm mb-0">Tóm tắt tất cả bài viết</p>
                    </div>

                    <div class="col-auto">
                        <label for="categoryFilter" class="form-label fw-bold">Danh mục:</label>
                        <select id="categoryFilter" class="form-select form-select-sm">
                            <option value="">Tất cả</option> <!-- Mặc định: không lọc -->
                            <!-- JS sẽ render các option còn lại -->
                        </select>
                    </div>
                </div>
                


                <div class="table-responsive ms-n1 ps-1 scrollbar">
                    <table class="table fs-9 mb-0 border-top border-translucent">
                        <thead>
                            <tr>
                                <th data-sort="title" data-label="Tiêu đề" style="cursor:pointer; width: 25%;">Tiêu đề</th>
                                <th data-sort="created_at" data-label="Ngày tạo" style="cursor:pointer">Ngày tạo</th>
                                <th data-sort="status" data-label="Trạng thái" style="cursor:pointer">Trạng thái</th>
                                <th data-sort="view" data-label="Lượt xem" style="cursor:pointer">Lượt xem</th>
                                <th data-sort="like" data-label="Thích" style="cursor:pointer">Thích</th>
                                <th data-sort="share" data-label="Chia sẻ" style="cursor:pointer">Chia sẻ</th>
                                <th>Đang ưu tiên</th>
                                <th class="text-end">Thao tác</th>





                            </tr>
                        </thead>
                        <tbody class="list" id="project-summary-table-body">
                            <!-- Dữ liệu sẽ được render bằng JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
                    <div class="col-auto d-flex">
                        <p class="mb-0 me-3 fw-semibold text-body" id="paging-info"></p>
                    </div>
                    <div class="col-auto d-flex">
                        <button class="page-link" id="prev-page"><span class="fas fa-chevron-left"></span></button>
                        <ul class="mb-0 pagination px-2" id="page-buttons"></ul>
                        <button class="page-link" id="next-page"><span class="fas fa-chevron-right"></span></button>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>


@section Scripts {

    <script>
        function loadCategories() {
            fetch("/apis/v1/category/list")
                .then(res => res.json())
                .then(result => {
                    if (!result.Success) {
                        alert("Không thể tải danh mục");
                        return;
                    }

                    const select = document.getElementById("categoryFilter");
                    select.innerHTML = `<option value="">Tất cả</option>`;

                    console.log(result.Data);

                    result.Data.forEach(cat => {
                        const option = document.createElement("option");
                        option.value = cat.Id;
                        option.textContent = cat.CategoryName;
                        document.getElementById("categoryFilter").appendChild(option);
                    });

                });
        }

        document.getElementById("categoryFilter").addEventListener("change", function () {
            categoryId = this.value;
            loadNews(1, pageSize); // load lại từ trang đầu
        });



        function formatDate(input) {
            const date = new Date(input);
            return date.toLocaleDateString("vi-VN");
        }

        function renderStatus(status) {
            switch (status) {
                case 0: return '<span class="badge bg-secondary">Ẩn</span>';
                case 1: return '<span class="badge bg-success">Hiển thị</span>';
                case 2: return '<span class="badge bg-warning text-dark">Lưu nháp</span>';
                default: return '<span class="badge bg-dark">Không rõ</span>';
            }
        }

        let currentPage = 1;
        let pageSize = 5;
        let categoryId = "";
        let totalRecords = 0;
        let sortBy = "created_at";
        let sortDir = "desc";


        function loadNews(page, size) {
            
            fetch(`/apis/v1/news/list?page=${page}&pageSize=${size}&sortBy=${sortBy}&sortDir=${sortDir}&categoryId=${categoryId}`)
                .then(response => response.json())
                .then(result => {
                    if (!result.Success) {
                        alert(result.Message);
                        return;
                    }

                    currentPage = page;
                    totalRecords = result.TotalRecords;

                    const tbody = document.getElementById("project-summary-table-body");
                    tbody.innerHTML = "";

                    result.Data.forEach((item) => {
                        const row = document.createElement("tr");
                        row.classList.add("position-static");

                        row.innerHTML = `
                                        <td class="align-middle project text-truncate" style="max-width: 250px;">
                                            <a class="fw-bold fs-8 text-decoration-none d-inline-block"
                                               title="${item.title}">
                                               ${item.title}
                                            </a>
                                        </td>
                                        <td class="align-middle start">
                                            <p class="mb-0 fs-9 text-body">${item.created_at}</p>
                                        </td>
                                        <td class="align-middle deadline">${renderStatus(item.status)}</td>
                                        <td class="align-middle"><span class="text-muted">${item.view ?? 0}</span></td>
                                        <td class="align-middle"><span class="text-muted">${item.like ?? 0}</span></td>
                                        <td class="align-middle"><span class="text-muted">${item.share ?? 0}</span></td>
                                        <td class="align-middle">
                                            ${item.is_priority ? '<span class="text-danger fw-bold">Đang ưu tiên</span>' : '<span class="text-muted">Không</span>'}
                                        </td>
                                        <td class="align-middle text-end action pe-0">
                                            <div class="btn-reveal-trigger position-static">
                                                <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal fs-10"
                                                        type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <span class="fas fa-ellipsis-h fs-10"></span>
                                                </button>
                                                <div class="dropdown-menu dropdown-menu-end py-2">
                                                    <a class="dropdown-item" href="#">Xem</a>
                                                    <a class="dropdown-item text-warning" href="/chinh-sua-bai-viet/${item.news_id}">Sửa</a>
                                                    <div class="dropdown-divider"></div>
                                                    <a class="dropdown-item text-danger" href="#">Xoá</a>
                                                </div>
                                            </div>
                                        </td>
                                    `;

                        tbody.appendChild(row);
                    });

                    updatePagination();
                });
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            const pagingInfo = document.getElementById("paging-info");
            const pageButtons = document.getElementById("page-buttons");

            pagingInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
            pageButtons.innerHTML = "";

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement("li");
                li.className = "page-item" + (i === currentPage ? " active" : "");

                const a = document.createElement("a");
                a.className = "page-link";
                a.href = "#";
                a.textContent = i;
                a.addEventListener("click", function (e) {
                    e.preventDefault();
                    loadNews(i, pageSize);
                });

                li.appendChild(a);
                pageButtons.appendChild(li);
            }

            document.getElementById("prev-page").onclick = function () {
                if (currentPage > 1) loadNews(currentPage - 1, pageSize);
            };
            document.getElementById("next-page").onclick = function () {
                if (currentPage < totalPages) loadNews(currentPage + 1, pageSize);
            };
        }

        document.addEventListener("DOMContentLoaded", function () {
            loadCategories();
            loadNews(1, 5);
        });

        document.querySelectorAll("th[data-sort]").forEach(th => {
            th.addEventListener("click", function () {
                const field = th.getAttribute("data-sort");
                if (sortBy === field) {
                    sortDir = sortDir === "asc" ? "desc" : "asc";
                } else {
                    sortBy = field;
                    sortDir = "asc"; // khi đổi cột thì reset về asc
                }
                loadNews(1, pageSize); // gọi lại API
                updateSortIcons();     // cập nhật icon ▲▼
            });
        });

        function updateSortIcons() {
            document.querySelectorAll("th[data-sort]").forEach(th => {
                const field = th.getAttribute("data-sort");
                const label = th.dataset.label || th.textContent.trim(); // fallback nếu quên gắn

                if (field === sortBy) {
                    th.innerHTML = `${label} ${sortDir === 'asc' ? '▲' : '▼'}`;
                } else {
                    th.innerHTML = label;
                }
            });
        }



    </script>

   
}
