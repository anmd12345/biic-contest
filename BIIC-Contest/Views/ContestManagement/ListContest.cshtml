@using BIIC_Contest.Constants
@{
    ViewBag.Title = "ListContest";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="row gx-6 gy-3 mb-4 align-items-center">
    <div class="col-auto">
        <h2 class="mb-0">Projects<span class="fw-normal text-body-tertiary ms-3">(32)</span></h2>
    </div>
</div>
<div class="row justify-content-between align-items-end mb-4 g-3">
    <div class="col-12 col-sm-auto">
        <ul class="nav nav-links mx-n2">
            <li class="nav-item"><a class="nav-link px-2 py-1 active" aria-current="page" href="#"><span>All</span><span class="text-body-tertiary fw-semibold">(32)</span></a></li>
            <li class="nav-item"><a class="nav-link px-2 py-1" href="#"><span>Ongoing</span><span class="text-body-tertiary fw-semibold">(14)</span></a></li>
            <li class="nav-item"><a class="nav-link px-2 py-1" href="#"><span>Cancelled</span><span class="text-body-tertiary fw-semibold">(2)</span></a></li>
            <li class="nav-item"><a class="nav-link px-2 py-1" href="#"><span>Finished</span><span class="text-body-tertiary fw-semibold">(14)</span></a></li>
            <li class="nav-item"><a class="nav-link px-2 py-1" href="#"><span>Postponed</span><span class="text-body-tertiary fw-semibold">(2)</span></a></li>
        </ul>
    </div>
    <div class="col-12 col-sm-auto">
        <div class="d-flex align-items-center">
            <div class="search-box me-3">
                <form class="position-relative">
                    <input class="form-control search-input search" type="search" placeholder="Search projects" aria-label="Search" />
                    <span class="fas fa-search search-box-icon"></span>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="row g-3 mb-9" id="contest-grid">



    @*<div class="col-12 col-sm-6 col-md-4 col-xxl-3">
            <div class="btn-reveal-trigger position-relative rounded-2 overflow-hidden p-4" style="height: 236px;">
                <div class="bg-holder" style="background-image: linear-gradient(180deg, rgba(0, 0, 0, 0) 39.41%, rgba(0, 0, 0, 0.4) 100%), url(/assets/img/event/banner_event_1.jpg)"></div>
                <div class="position-relative h-100 d-flex flex-column justify-content-between">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge badge-phoenix fs-10 badge-phoenix-primary" data-bs-theme="light">Ongoing</span>
                        <div class="z-2">
                            <button class="btn btn-icon btn-reveal dropdown-toggle dropdown-caret-none transition-none" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-v"></span></button>
                            <div class="dropdown-menu dropdown-menu-end py-2">
                                <a class="dropdown-item" href="@RouteConstant.BASE_LIST_SUBMISSION_ROUTE">Xem danh sách bài dự thi</a>
                                <a class="dropdown-item" href="#!">Export</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger" href="#!">Remove</a>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-white fw-bold line-clamp-2">Project Doughnut Dungeon</h3>
                </div>
            </div>
        </div>*@
</div>
<div id="pagination-container" class="mt-4 text-center">
    <!-- phân trang JS sẽ render ở đây -->
</div>



@section Scripts{
    <script>
        let currentPage = 1;
        let totalRecords = 0;
        const pageSize = 9;
        const categoryId = 3;
        const sortBy = "created_at";
        const sortDir = "desc";

        function loadContests(page = 1) {
            fetch(`/apis/v1/news/list?page=${page}&pageSize=${pageSize}&sortBy=${sortBy}&sortDir=${sortDir}&categoryId=${categoryId}`)
                .then(response => response.json())
                .then(result => {
                    console.log("DATA:", result.Data);
                    if (!result.Success) {
                        alert(result.Message);
                        return;
                    }

                    currentPage = page;
                    totalRecords = result.TotalRecords;

                    const container = document.getElementById("contest-grid");
                    container.innerHTML = "";

                    result.Data.forEach(item => {
                        const card = document.createElement("div");
                        card.className = "col-12 col-sm-6 col-md-4 col-xxl-3";

                        card.innerHTML = `
                            <div class="btn-reveal-trigger position-relative rounded-2 overflow-hidden p-4" style="height: 236px;">
                                <div class="bg-holder" style="background-image: linear-gradient(180deg, rgba(0, 0, 0, 0.4) 100%), url('${item.banner_url || "/assets/img/event/banner_event_1.jpg"}'); background-size: cover;"></div>
                                <div class="position-relative h-100 d-flex flex-column justify-content-between">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge fw-bold px-3 py-2 rounded-pill fs-9 ${getStatusBadgeClass(item.status)}">
    ${renderStatus(item.status)}
</span>

                                        <div class="z-2">
                                            <button class="btn btn-icon btn-reveal dropdown-toggle dropdown-caret-none transition-none" data-bs-toggle="dropdown"><span class="fas fa-ellipsis-v"></span></button>
                                            <div class="dropdown-menu dropdown-menu-end py-2">
                                                <a class="dropdown-item" href="#">Xem bài dự thi</a>
                                                <a class="dropdown-item text-warning" href="/chinh-sua-cuoc-thi/${item.news_id}">Sửa</a>
                                                <div class="dropdown-divider"></div>
                                                <a class="dropdown-item text-danger btn-delete-contest" data-id="${item.news_id}" href="#">Xoá</a>
                                            </div>
                                        </div>
                                    </div>
                                    <h3 class="text-white fw-bold line-clamp-2">${item.title}</h3>
                                </div>
                            </div>
                        `;

                        container.appendChild(card);
                    });

                    updatePagination();
                    
                });


        }

        function renderStatus(status) {
            switch (status) {
                case 0: return "Ẩn";
                case 1: return "Hiển thị";
                case 2: return "Lưu nháp";
                default: return "Không rõ";
            }
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 0: return "bg-secondary text-white"; // Ẩn
                case 1: return "bg-success text-white";   // Hiển thị
                case 2: return "bg-warning text-dark";    // Lưu nháp
                default: return "bg-light text-dark";
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            loadContests(1);
        });

        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("btn-delete-contest")) {
                e.preventDefault();

                const id = e.target.dataset.id;

                if (!id) {
                    alert("Không tìm thấy ID cuộc thi.");
                    return;
                }

                if (confirm("Bạn có chắc chắn muốn xoá cuộc thi này?")) {
                    fetch("/apis/v1/contest/delete", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: `newsId=${id}` // ✅ Phải là newsId để match tham số API
                    })
                        .then(res => res.json())
                        .then(result => {
                            if (result.Success) {
                                alert("Đã xoá cuộc thi thành công.");
                                loadContests(currentPage); // Reload danh sách
                            } else {
                                alert("Xóa thất bại: " + result.Message);
                            }
                        })
                        .catch(err => {
                            alert("Lỗi khi xoá cuộc thi.");
                            console.error(err);
                        });
                }
            }
        });

    </script>
   


}




@functions {
    public string getStatusText(short status)
    {
        switch (status)
        {
            case 0: return "Ẩn";
            case 1: return "Hiển thị";
            case 2: return "Lưu nháp";
            default: return "Không rõ";
        }
    }
}
